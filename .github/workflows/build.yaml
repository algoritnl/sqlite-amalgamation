name: Build

on: [push, pull_request]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up build environment
        run: cmake -E make_directory ${{runner.workspace}}/build

      - name: Generate build system
        working-directory: ${{runner.workspace}}/build
        run: cmake $GITHUB_WORKSPACE
                   -DCMAKE_BUILD_TYPE:STRING=$BUILD_TYPE
                   -DBUILD_SHARED_LIBS:BOOL=ON
                   -DBUILD_TESTING:BOOL=ON

      - name: Build targets
        working-directory: ${{runner.workspace}}/build
        run: cmake --build .

      - name: Perform tests
        working-directory: ${{runner.workspace}}/build
        run: ctest -C $BUILD_TYPE -V

  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up build environment
        run: cmake -E make_directory ${{runner.workspace}}/build

      - name: Generate build system
        working-directory: ${{runner.workspace}}/build
        run: cmake $GITHUB_WORKSPACE
                   -DCMAKE_BUILD_TYPE:STRING=$BUILD_TYPE
                   -DBUILD_SHARED_LIBS:BOOL=ON
                   -DBUILD_TESTING:BOOL=ON

      - name: Build targets
        working-directory: ${{runner.workspace}}/build
        run: cmake --build .

      - name: Perform tests
        working-directory: ${{runner.workspace}}/build
        run: ctest -C $BUILD_TYPE -V

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up build environment
        run: cmake -E make_directory ${{runner.workspace}}\build

      - name: Generate build system
        working-directory: ${{runner.workspace}}\build
        run: cmake ${env:GITHUB_WORKSPACE}
                   -DBUILD_SHARED_LIBS:BOOL=ON
                   -DBUILD_TESTING:BOOL=ON

      - name: Build targets
        working-directory: ${{runner.workspace}}\build
        run: cmake --build . --config ${env:BUILD_TYPE}

      - name: Perform tests
        working-directory: ${{runner.workspace}}\build
        run: ctest -C ${env:BUILD_TYPE} -V
